<!DOCTYPE html>

<html lang="zh-TW">

<head>

    <meta charset="UTF-8">

    <title>æ–½å·¥è¡¨å–®ç”Ÿæˆå™¨ (V44 çµ•å°è²«ç©¿ç‰ˆ)</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>



    <style>

        :root { --primary: #2c3e50; --bg: #f4f7f6; --accent: #27ae60; --blue: #2980b9; --orange: #e67e22; }

        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        

        .header { background: #fff; padding: 10px 25px; border-bottom: 2px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }

        .main { flex: 1; display: flex; padding: 20px; gap: 20px; overflow: hidden; }

        .form-panel { width: 380px; background: #fff; padding: 20px; overflow-y: auto; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); flex-shrink: 0; }

        .preview-panel { flex: 1; background: #95a5a6; padding: 30px; overflow: auto; display: flex; justify-content: center; align-items: flex-start; }



        /* --- æµç¨‹åœ–ç•«å¸ƒæ ¸å¿ƒ --- */

        .flowchart-container { 

            width: 17.5cm; background: #fff; padding: 50px 40px; box-sizing: border-box; 

            display: flex; flex-direction: column; position: relative;

            font-family: "DFKai-SB", "æ¨™æ¥·é«”", serif; box-shadow: 0 0 20px rgba(0,0,0,0.2);

        }



        /* é—œéµï¼šç•«ä¸€æ¢è²«ç©¿æ•´å€‹å®¹å™¨çš„å‚ç›´å¯¦ç·š */

        .flowchart-container::before {

            content: "";

            position: absolute;

            left: calc(40px + 75px); /* padding + node-colä¸€åŠ */

            top: 80px;    /* å¾ç¬¬ä¸€å€‹æ–¹å¡Šä¸­å¿ƒé–‹å§‹ */

            bottom: 80px; /* åˆ°æœ€å¾Œä¸€å€‹æ–¹å¡Šä¸­å¿ƒçµæŸ */

            width: 1.5px;

            background: #000;

            z-index: 1;

        }



        .flow-row { 

            display: flex; width: 100%; align-items: center; position: relative; 

            z-index: 2; /* ç¢ºä¿å…§å®¹åœ¨è²«ç©¿ç·šä¸Šæ–¹ */

            min-height: 85px; 

        }



        .node-col { 

            width: 150px; display: flex; flex-direction: column; 

            justify-content: center; align-items: center; flex-shrink: 0; 

        }



        .node-wrapper { 

            display: flex; flex-direction: column; align-items: center; 

            background: #fff; /* ç™½è‰²èƒŒæ™¯é®ä½ä¸‹æ–¹çš„è²«ç©¿ç·š */

            padding: 5px 0;

        }



        /* çµ±ä¸€å­—é«” 14pt */

        .node-box { 

            width: 130px; padding: 8px 4px; border: 1.5px solid #000; 

            text-align: center; background: #fff; font-weight: bold; 

            font-size: 14pt; box-sizing: border-box; line-height: 1.2;

        }

        .node-box.oval { border-radius: 45px; }



        /* å‘ä¸‹ç®­é ­ï¼šç²¾æº–æ”¾åœ¨æ–¹å¡Šæ­£ä¸Šæ–¹ */

        .arrow-head { 

            width: 0; height: 0; 

            border-left: 6px solid transparent; border-right: 6px solid transparent; 

            border-top: 10px solid #000; 

            margin-bottom: 2px;

        }



        .detail-col { flex: 1; display: flex; align-items: center; }



        /* æ°´å¹³é€£ç·šï¼šç²¾æº–æŠµé”é‚Šç·£ */

        .h-line { 

            width: 35px; border-top: 1.5px dashed #000; flex-shrink: 0; 

            margin-right: -1px;

        }



        .detail-box { 

            border: 1.5px dashed #000; padding: 10px 15px; font-size: 14pt; 

            background: #fff; line-height: 1.5; display: inline-block; max-width: 100%; 

            word-break: break-all; text-align: left; 

        }



        .group-item { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }

    </style>

</head>

<body>



<div class="header">

    <h3 style="margin:0;">ğŸ—ï¸ æ–½å·¥è¡¨å–®ç”Ÿæˆå™¨ (V44 çµ•å°è²«ç©¿ç‰ˆ)</h3>

    <div class="btn-group">

        <button class="btn btn-blue" onclick="exportFlow()">ğŸ“¥ æµç¨‹åœ–</button>

        <button class="btn btn-green" onclick="exportStandard()">ğŸ“‹ æ¨™æº–è¡¨</button>

        <button class="btn btn-orange" onclick="exportRecord()">ğŸ“ ç´€éŒ„è¡¨</button>

    </div>

</div>



<div class="main">

    <div class="form-panel">

        <div class="input-group"><label>å·¥ç¨‹åç¨±ï¼š</label><input type="text" id="projName" value="ä¸­å’Œå€éŒ¦å’Œé‹å‹•å…¬åœ’æ•´é«”è¦åŠƒæ”¹å–„å·¥ç¨‹"></div>

        <div class="input-group"><label>åˆ†é …å·¥ç¨‹é¸æ“‡ï¼š</label><select id="minorSelect" onchange="loadForm()"></select></div>

        <hr>

        <div id="formContainer">è¼‰å…¥ä¸­...</div>

    </div>

    <div class="preview-panel">

        <div id="flowchart-canvas" class="flowchart-container"></div>

    </div>

</div>



<script>

    const SS_ID = "1tCW1yzvBnzoQv2mAcLhAWcKOTe8mrOkyavWHaXRii3U";

    let rawData = [];



    // è³‡æ–™è®€å–

    document.addEventListener("DOMContentLoaded", () => {

        window.loader = (json) => {

            if (!json.table) return;

            rawData = json.table.rows.map(r => ({

                stage: r.c[3]?.v || "", minor: r.c[1]?.v || "", node: r.c[4]?.v || "",

                item: r.c[5]?.v || "", std: r.c[6]?.v || "", timing: r.c[7]?.v || "",

                method: r.c[8]?.v || "", freq: r.c[9]?.v || "", failProc: r.c[10]?.v || ""

            })).filter(r => r.node && r.node !== "æ–½å·¥æµç¨‹");

            const minors = [...new Set(rawData.map(r => r.minor))];

            document.getElementById('minorSelect').innerHTML = minors.map(m => `<option value="${m}">${m}</option>`).join('');

            loadForm();

        };

        const s = document.createElement('script');

        s.src = `https://docs.google.com/spreadsheets/d/${SS_ID}/gviz/tq?tqx=responseHandler:loader`;

        document.body.appendChild(s);

    });



    function loadForm() {

        const sel = document.getElementById('minorSelect').value;

        const groups = {};

        rawData.filter(r => r.minor === sel).forEach(r => {

            if (!groups[r.node]) groups[r.node] = [];

            if (r.item) groups[r.node].push(r);

        });

        document.getElementById('formContainer').innerHTML = Object.keys(groups).map(node => `

            <div class="group-item">

                <strong style="font-size:14px;">${node}</strong>

                ${groups[node].map(r => `<label style="display:flex; gap:5px; font-size:12px; margin-top:4px;"><input type="checkbox" class="chk" data-info='${JSON.stringify(r).replace(/'/g, "&apos;")}' checked onchange="updatePreview()"><span>${r.item}</span></label>`).join('')}

            </div>

        `).join('');

        updatePreview();

    }



    function createRow(txt, items, shape, isStart = false) {

        const row = document.createElement('div'); row.className = 'flow-row';

        let detailHtml = items.length ? `<div class="h-line"></div><div class="detail-box">${items.map((it, i) => `${i + 1}.${it}`).join('<br>')}</div>` : '';



        row.innerHTML = `

            <div class="node-col">

                <div class="node-wrapper">

                    ${!isStart ? '<div class="arrow-head"></div>' : ''}

                    <div class="node-box ${shape}">${txt}</div>

                </div>

            </div>

            <div class="detail-col">${detailHtml}</div>

        `;

        return row;

    }



    function updatePreview() {

        const canvas = document.getElementById('flowchart-canvas'); canvas.innerHTML = '';

        const chks = Array.from(document.querySelectorAll('.chk:checked'));

        const flow = new Map();

        chks.forEach(c => {

            const data = JSON.parse(c.dataset.info);

            if(!flow.has(data.node)) flow.set(data.node, []);

            flow.get(data.node).push(data.item);

        });

        if(flow.size === 0) return;



        canvas.appendChild(createRow("æº–å‚™", [], "oval", true));

        flow.forEach((items, node) => canvas.appendChild(createRow(node, items, "rect")));

        canvas.appendChild(createRow("å®Œæˆ", [], "oval"));

    }



    // åŒ¯å‡ºåŠŸèƒ½ä¿ç•™å®Œæ•´é‚è¼¯

    async function exportFlow() {

        const canvas = document.getElementById('flowchart-canvas');

        const img = await html2canvas(canvas, { scale: 3, useCORS: true });

        const html = `<html><body style="font-family:æ¨™æ¥·é«”; text-align:center;"><h2>æ–½å·¥æµç¨‹åœ–</h2><img src="${img.toDataURL()}" width="590"></body></html>`;

        saveAs(new Blob(['\ufeff' + html], { type: 'application/msword' }), `æµç¨‹åœ–.doc`);

    }



    function exportStandard() {

        const selMinor = document.getElementById('minorSelect').value;

        const selectedItems = Array.from(document.querySelectorAll('.chk:checked')).map(c => JSON.parse(c.dataset.info));

        let tableRows = '';

        selectedItems.forEach((r) => {

            tableRows += `<tr><td style="border:1px solid black; text-align:center;">${r.stage}</td><td style="border:1px solid black; text-align:center;">${r.node}</td><td style="border:1px solid black;">${r.item}</td><td style="border:1px solid black;">${r.std.replace(/\n/g, '<br>')}</td><td style="border:1px solid black; text-align:center;">${r.timing}</td><td style="border:1px solid black; text-align:center;">${r.method}</td><td style="border:1px solid black; text-align:center;">${r.freq}</td><td style="border:1px solid black; text-align:center;">${r.failProc}</td><td style="border:1px solid black; text-align:center;">æŠ½æŸ¥ç´€éŒ„</td><td style="border:1px solid black;"></td></tr>`;

        });

        const html = `<html><head><style>@page Section2 { size: 841.9pt 595.3pt; mso-page-orientation: landscape; margin: 36pt; } div.Section2 { page: Section2; } body { font-family: "æ¨™æ¥·é«”"; } table { width: 100%; border-collapse: collapse; } th, td { border: 1px solid black; padding: 4px; font-size: 10pt; }</style></head><body><div class="Section2"><h2 align="center">${selMinor} æ¨™æº–è¡¨</h2><table><tr style="font-weight:bold;"><th>éšæ®µ</th><th>æµç¨‹</th><th>é …ç›®</th><th>æŠ½æŸ¥æ¨™æº–</th><th>æ™‚æ©Ÿ</th><th>æ–¹æ³•</th><th>é »ç‡</th><th>ä¸åˆæ ¼è™•ç†</th><th>ç´€éŒ„</th><th>å‚™è¨»</th></tr>${tableRows}</table></div></body></html>`;

        saveAs(new Blob(['\ufeff' + html], { type: 'application/msword' }), `${selMinor}_æ¨™æº–è¡¨.doc`);

    }



    function exportRecord() {

        const pName = document.getElementById('projName').value;

        const selMinor = document.getElementById('minorSelect').value;

        const selectedItems = Array.from(document.querySelectorAll('.chk:checked')).map(c => JSON.parse(c.dataset.info));

        let tableRows = '';

        selectedItems.forEach((r) => {

            tableRows += `<tr><td style="border:1px solid black; text-align:center;">${r.stage}</td><td style="border:1px solid black; text-align:center;">${r.node}</td><td style="border:1px solid black;">${r.item}</td><td style="border:1px solid black;">${r.std.replace(/\n/g, '<br>')}</td><td style="border:1px solid black; width:80pt;"></td><td style="border:1px solid black; width:40pt;"></td></tr>`;

        });

        const header = `<table style="width:100%; border:1px solid black; border-collapse:collapse; margin-bottom:10px;"><tr><td style="border:1px solid black; width:18%; text-align:center;">å·¥ç¨‹åç¨±</td><td style="border:1px solid black; padding-left:5px;">${pName}</td></tr><tr><td style="border:1px solid black; text-align:center;">åˆ†é …å·¥ç¨‹</td><td style="border:1px solid black; padding-left:5px;">${selMinor}</td></tr></table>`;

        const html = `<html><head><style>body { font-family: "æ¨™æ¥·é«”"; } table { width: 100%; border-collapse: collapse; } th, td { border: 1px solid black; padding: 4px; font-size: 11pt; }</style></head><body><h2 align="center">æ–½å·¥æŠ½æŸ¥ç´€éŒ„è¡¨</h2>${header}<table><tr style="font-weight:bold;"><th colspan="3">æª¢æŸ¥é …ç›®</th><th>æ¨™æº–</th><th width="80pt">å¯¦éš›æƒ…å½¢</th><th width="40pt">çµæœ</th></tr>${tableRows}</table></body></html>`;

        saveAs(new Blob(['\ufeff' + html], { type: 'application/msword' }), `${selMinor}_ç´€éŒ„è¡¨.doc`);

    }

</script>

</body>

</html>

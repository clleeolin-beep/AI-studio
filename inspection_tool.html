<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–½å·¥æµç¨‹åœ–ç”Ÿæˆå™¨ (ç®­é ­ç²¾æº–è²¼åˆç‰ˆ)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://unpkg.com/docxtemplater@3.37.2/build/docxtemplater.js"></script>
<script src="https://unpkg.com/docxtemplater-image-module-free@1.1.1/build/imagemodule.js"></script>
    <style>
        :root { --primary: #1a5276; --accent: #2980b9; --bg: #eef2f5; --hp-color: #e74c3c; --card-bg: #ffffff; }
        
        body { 
            font-family: "BiauKai", "DFKai-SB", "æ¨™æ¥·é«”", serif; 
            margin: 0; padding: 0; 
            background: var(--bg); 
            height: 100vh; 
            display: flex; flex-direction: column; overflow: hidden; 
        }

        /* é ‚éƒ¨å°èˆª */
        .header-wrapper { background: #fff; border-bottom: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 10; flex-shrink: 0; }
        .header-content { max-width: 1280px; margin: 0 auto; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; height: 50px; font-family: "Microsoft JhengHei", sans-serif; }
        h2 { margin: 0; font-size: 18px; color: var(--primary); }
        .controls { display: flex; gap: 10px; align-items: center; }
        select { padding: 6px; border-radius: 4px; border: 1px solid #ccc; font-family: "Microsoft JhengHei"; }
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; color: white; display: flex; align-items: center; gap: 5px; font-family: "Microsoft JhengHei"; }
        .btn-word { background: #27ae60; }
        .btn-word:hover { background: #219150; }

        /* ä¸»å…§å®¹å€ */
        .main-wrapper { flex: 1; display: flex; justify-content: center; padding: 20px; overflow: hidden; }
        .main-card { display: flex; width: 100%; max-width: 1380px; background: var(--card-bg); border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); overflow: hidden; border: 1px solid #e1e4e8; }

        /* å·¦å´è¡¨å–® */
        .form-panel { width: 30%; background: #fdfdfd; border-right: 1px solid #eee; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; font-family: "Microsoft JhengHei"; }
        
        /* å³å´é è¦½ */
        .preview-panel { width: 70%; background: #e0e5ec; overflow: auto; padding: 40px; display: flex; flex-direction: column; align-items: center; position: relative; }

        /* --- V12 æ’ç‰ˆå¼•æ“ (ç®­é ­ä¿®æ­£) --- */
        .flowchart-container { 
            display: flex; flex-direction: column; align-items: stretch; position: relative; 
            width: 15.7cm; min-height: 23cm; background: #fff; padding: 1cm 0.5cm; 
            box-shadow: 0 0 15px rgba(0,0,0,0.1); box-sizing: border-box; 
        }

        .height-limit-line { position: absolute; top: 23cm; left: 0; width: 100%; border-bottom: 2px dashed red; pointer-events: none; z-index: 10; }
        .height-limit-line::after { content: "âš ï¸ 23cm é«˜åº¦é™åˆ¶ç·š"; position: absolute; right: 0; top: -20px; color: red; font-size: 12px; font-family: sans-serif; background: rgba(255,255,255,0.8); }
        
        .flow-row { display: flex; align-items: stretch; min-height: 80px; width: 100%; margin-bottom: 0px; }
        
        /* å·¦æ¬„ (ä¸»æµç¨‹) */
        .node-col { 
            width: 4.5cm; position: relative; 
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center; 
            flex-shrink: 0; 
        }

        /* V12: æ–°å¢ Wrapper è®“ç®­é ­ç·Šè²¼æ–¹å¡Š */
        .node-wrapper {
            position: relative;
            z-index: 2; /* é«˜æ–¼ç·šæ¢ */
        }
        
        /* ç¯€é»æ–¹å¡Š */
        .node-box { 
            width: 3.5cm; padding: 10px 5px; background: #fff; border: 1.5px solid #000; 
            text-align: center; font-family: "BiauKai", "DFKai-SB", "æ¨™æ¥·é«”", serif; 
            font-size: 12pt; font-weight: bold; position: relative; 
            display: flex; align-items: center; justify-content: center;
        }
        .node-box.oval { border-radius: 50%; height: 1.2cm; width: 2.5cm; padding: 5px; }
        .node-box.rect { border-radius: 0; min-height: 1.2cm; }
        
        .hp-star { color: red; margin-right: 4px; font-size: 14pt; vertical-align: middle; }

        /* è²«ç©¿ç·š (èƒŒæ™¯) */
        .v-line { position: absolute; left: 50%; transform: translateX(-50%); width: 1.5px; background: #000; z-index: 1; }
        .line-full { top: 0; bottom: 0; }
        .line-start { top: 50%; bottom: 0; }
        .line-end { top: 0; bottom: 50%; }

        /* V12: ç®­é ­ (çµ•å°å®šä½æ–¼ Wrapper é ‚éƒ¨) */
        .arrow-down { 
            width: 0; height: 0; 
            border-left: 5px solid transparent; 
            border-right: 5px solid transparent; 
            border-top: 10px solid #000; 
            position: absolute; 
            left: 50%; 
            transform: translateX(-50%); 
            bottom: 100%; /* è²¼é½Šæ–¹å¡Šä¸Šç·£ */
            z-index: 3; 
            margin-bottom: -1px; /* å¾®èª¿ä¿®è£œç¸«éš™ */
        }

        /* å³æ¬„ (ç´°é …) */
        .detail-col { flex: 1; display: flex; align-items: center; position: relative; padding-left: 0; }
        .h-connector { width: 1cm; height: 1px; border-top: 1.5px dashed #000; flex-shrink: 0; }
        .detail-box { 
            border: 1.5px dashed #000; padding: 8px 12px; background: #fff; 
            font-family: "BiauKai", "DFKai-SB", "æ¨™æ¥·é«”", serif; font-size: 12pt; 
            line-height: 1.5; text-align: left; width: fit-content; max-width: 9.5cm; min-width: 2cm;
        }

        .edit-input { border: none; border-bottom: 1px dashed #ccc; background: transparent; font-family: "Microsoft JhengHei"; font-size: 14px; width: 100%; padding: 2px; }
        .edit-input:focus { outline: none; border-bottom: 2px solid var(--accent); background: #fff; }

        .group-header { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 10px; margin-top: 15px; border-radius: 5px 5px 0 0; border-left: 5px solid var(--primary); border: 1px solid #eee; border-left-width: 5px; }
        .group-header.hp { border-left-color: var(--hp-color); }
        .item-list { border: 1px solid #eee; border-top: none; padding: 10px; margin-bottom: 5px; background: #fff; border-radius: 0 0 5px 5px; }
        .check-row { display: flex; align-items: flex-start; padding: 8px 0; border-bottom: 1px solid #f9f9f9; }
        .std-text { display: block; font-size: 12px; color: #999; margin-top: 2px; padding-left: 5px; font-family: "Microsoft JhengHei"; }
        .btn-toggle { background: none; border: 1px solid #ccc; color: #666; padding: 2px 8px; font-size: 12px; border-radius: 3px; cursor: pointer; font-family: "Microsoft JhengHei"; }

        @media (max-width: 768px) {
            .main-card { flex-direction: column; }
            .form-panel, .preview-panel { width: 100%; height: 50%; }
        }
    </style>
</head>
<body>

<div class="header-wrapper">
    <div class="header-content">
        <div style="display:flex; align-items:center; gap:10px;">
            <h2>ğŸ—ï¸ æ–½å·¥è¨ˆç•«æµç¨‹è£½ä½œå·¥å…·</h2>
            <span id="status" style="font-size:12px; color:#888;">é€£ç·šä¸­...</span>
        </div>
        <div class="controls">
            <select id="minorSelect" onchange="loadForm()"></select>
            <button class="btn btn-word" onclick="exportToWord()">
                ğŸ“¥ åŒ¯å‡º Word (A4æ ¼å¼)
            </button>
        </div>
    </div>
</div>

<div class="main-wrapper">
    <div class="main-card">
        <div class="form-panel" id="formContainer">
            <div style="text-align:center; color:#999; margin-top:50px;">è³‡æ–™è®€å–ä¸­...</div>
        </div>
        <div class="preview-panel">
            <h4 style="margin:0 0 10px 0; color:#555; font-family:'Microsoft JhengHei';">æµç¨‹åœ–é è¦½ (å¯¬åº¦ 15.7cm)</h4>
            <div id="flowchart-canvas" class="flowchart-container">
                <div class="height-limit-line"></div>
                </div>
        </div>
    </div>
</div>

<script>
    const SS_ID = "1tCW1yzvBnzoQv2mAcLhAWcKOTe8mrOkyavWHaXRii3U"; 
    const SHEET_NAME = "å·¥ä½œè¡¨1"; 

    let rawData = [];
    
    document.addEventListener("DOMContentLoaded", function() {
        loadGoogleSheet();
    });

    function loadGoogleSheet() {
        const cbName = "callback_loader";
        window[cbName] = (json) => {
            if (json.table) {
                rawData = json.table.rows.map((row, idx) => {
                    const get = (i) => (row.c && row.c[i]) ? (row.c[i].f || row.c[i].v || "") : "";
                    return {
                        id: idx,
                        minor: get(1),
                        hp: get(2).includes('HP'),
                        process: get(4),
                        item: get(5),
                        standard: get(6)
                    };
                }).filter(r => r.process && r.process !== "æ–½å·¥æµç¨‹" && r.minor);

                initMenu();
                document.getElementById('status').innerText = "å°±ç·’";
            }
        };
        const script = document.createElement('script');
        script.src = `https://docs.google.com/spreadsheets/d/${SS_ID}/gviz/tq?tqx=responseHandler:${cbName}&sheet=${encodeURIComponent(SHEET_NAME)}`;
        document.body.appendChild(script);
    }

    function initMenu() {
        const minors = [...new Set(rawData.map(r => r.minor))];
        const select = document.getElementById('minorSelect');
        select.innerHTML = '';
        minors.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m;
            opt.innerText = m;
            select.appendChild(opt);
        });
        if(minors.length > 0) loadForm();
    }

    function loadForm() {
        const selectedMinor = document.getElementById('minorSelect').value;
        const currentItems = rawData.filter(r => r.minor === selectedMinor);
        
        const groups = {};
        currentItems.forEach(r => {
            if (!groups[r.process]) groups[r.process] = { hp: r.hp, items: [] };
            if (r.item) groups[r.process].items.push(r);
        });

        const container = document.getElementById('formContainer');
        container.innerHTML = '';

        Object.keys(groups).forEach((procName, idx) => {
            const grp = groups[procName];
            const div = document.createElement('div');
            
            let itemsHtml = grp.items.map((it, i) => `
                <div class="check-row">
                    <input type="checkbox" id="chk_${it.id}" value="${it.id}" checked onchange="updatePreview()">
                    <div style="width:100%">
                        <input type="text" class="edit-input" id="txt_${it.id}" value="${it.item}" oninput="updatePreview()">
                        <span class="std-text">${it.standard || ''}</span>
                    </div>
                </div>
            `).join('');

            if(grp.items.length === 0) {
                 itemsHtml = `<div class="check-row" style="display:none;">
                    <input type="checkbox" id="chk_proc_${idx}" value="PROC_${procName}" checked onchange="updatePreview()">
                 </div><div style="color:#aaa; font-size:12px; font-family:'Microsoft JhengHei'">ç„¡æª¢æŸ¥ç´°é …</div>`;
            }

            div.innerHTML = `
                <div class="group-header ${grp.hp ? 'hp' : ''}">
                    <span class="group-title" style="font-family:'Microsoft JhengHei'">${idx+1}. ${procName}</span>
                    <button class="btn-toggle" onclick="toggleGroup(this)">å…¨é¸</button>
                </div>
                <div class="item-list">${itemsHtml}</div>
            `;
            container.appendChild(div);
        });
        updatePreview();
    }

    function toggleGroup(btn) {
        const list = btn.parentElement.nextElementSibling;
        const checks = list.querySelectorAll('input[type="checkbox"]');
        const isAllChecked = Array.from(checks).every(c => c.checked);
        checks.forEach(c => c.checked = !isAllChecked);
        updatePreview();
    }

    function updatePreview() {
        const canvas = document.getElementById('flowchart-canvas');
        const limitLine = canvas.querySelector('.height-limit-line');
        canvas.innerHTML = ''; 
        if(limitLine) canvas.appendChild(limitLine);

        const checkedBoxes = document.querySelectorAll('#formContainer input[type="checkbox"]:checked');
        const checkedIds = new Set(Array.from(checkedBoxes).map(cb => cb.value));
        const selectedMinor = document.getElementById('minorSelect').value;
        const currentItems = rawData.filter(r => r.minor === selectedMinor);

        const flowMap = new Map();
        currentItems.forEach(row => {
            const isChecked = checkedIds.has(String(row.id));
            const isProcChecked = checkedIds.has(`PROC_${row.process}`);
            
            if (isChecked || isProcChecked) {
                if (!flowMap.has(row.process)) {
                    flowMap.set(row.process, { name: row.process, isHp: row.hp, items: [] });
                }
                if (isChecked && row.item) {
                    const inputEl = document.getElementById(`txt_${row.id}`);
                    const displayText = inputEl ? inputEl.value : row.item;
                    flowMap.get(row.process).items.push(displayText);
                }
            }
        });

        if (flowMap.size === 0) return;

        canvas.appendChild(createRow('Start', 'æº–å‚™', false, [], 'line-start'));

        const flowArray = Array.from(flowMap.values());
        flowArray.forEach((val, index) => {
            const row = createRow('Process', val.name, val.isHp, val.items, 'line-full');
            canvas.appendChild(row);
        });

        const endRow = createRow('End', 'å®Œæˆ', false, [], 'line-end');
        canvas.appendChild(endRow);
    }

    function createRow(type, text, isHp, items, lineType) {
        const row = document.createElement('div');
        row.className = 'flow-row';

        const leftCol = document.createElement('div');
        leftCol.className = 'node-col';

        // ç·šæ¢èƒŒæ™¯
        const line = document.createElement('div');
        line.className = `v-line ${lineType}`;
        leftCol.appendChild(line);

        // Wrapper ç¶å®šç®­é ­èˆ‡æ–¹å¡Š
        const wrapper = document.createElement('div');
        wrapper.className = 'node-wrapper';

        if (type === 'Process' || type === 'End') {
            const arrow = document.createElement('div');
            arrow.className = 'arrow-down';
            wrapper.appendChild(arrow);
        }

        const box = document.createElement('div');
        box.className = type === 'Process' ? 'node-box rect' : 'node-box oval';
        box.innerHTML = (isHp ? '<span class="hp-star">â˜…</span>' : '') + text;
        wrapper.appendChild(box);
        leftCol.appendChild(wrapper);

        row.appendChild(leftCol);

        const rightCol = document.createElement('div');
        rightCol.className = 'detail-col';

        if (type === 'Process' && items && items.length > 0) {
            const connector = document.createElement('div');
            connector.className = 'h-connector';
            rightCol.appendChild(connector);

            const detailBox = document.createElement('div');
            detailBox.className = 'detail-box';
            detailBox.innerHTML = items.map((it, i) => `${i+1}. ${it}`).join('<br>');
            rightCol.appendChild(detailBox);
        }

        row.appendChild(rightCol);
        return row;
    }

    function exportToWord() {
        const element = document.getElementById('flowchart-canvas');
        if (!element || element.innerText.trim() === '') { alert("è«‹å…ˆç”¢ç”Ÿæµç¨‹åœ–"); return; }
        
        const limitLine = element.querySelector('.height-limit-line');
        if(limitLine) limitLine.style.display = 'none';

        const btn = document.querySelector('.btn-word');
        const originalText = btn.innerText;
        btn.innerText = "ç”Ÿæˆä¸­...";

        html2canvas(element, { scale: 3, backgroundColor: "#ffffff" }).then(canvas => {
            const imgData = canvas.toDataURL("image/png");
            generateDoc(imgData);
            if(limitLine) limitLine.style.display = 'block';
            btn.innerText = originalText;
        }).catch(err => {
            console.error(err);
            alert("åœ–ç‰‡ç”Ÿæˆå¤±æ•—");
            if(limitLine) limitLine.style.display = 'block';
            btn.innerText = originalText;
        });
    }
// åœ¨ <head> ä¸­æ›´æ›é€™çµ„é€£çµï¼Œç¢ºä¿é †åºæ­£ç¢º
// <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
// <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
// <script src="https://unpkg.com/docxtemplater@3.37.2/build/docxtemplater.js"></script>
// <script src="https://unpkg.com/docxtemplater-image-module-free@1.1.1/build/imagemodule.js"></script>

async function generateDoc(imgData) {
    const selectedMinor = document.getElementById('minorSelect').value;
    const btn = document.querySelector('.btn-word');
    const originalText = btn.innerText;
    
    btn.innerText = "èª¿ç”¨ç¯„æœ¬ä¸­...";

    try {
        // 1. è®€å–ä¼ºæœå™¨ç›®éŒ„ä¸‹çš„ç¯„æœ¬ (è«‹ç¢ºèªæª”æ¡ˆå·²ä¸Šå‚³è‡³èˆ‡ HTML åŒä¸€ç›®éŒ„)
        const response = await fetch('./æ–½å·¥æŠ½æŸ¥æµç¨‹åœ–ç¯„ä¾‹.docx');
        if (!response.ok) throw new Error("æ‰¾ä¸åˆ°ç¯„æœ¬æª”æ¡ˆï¼Œè«‹ç¢ºèªæª”æ¡ˆå·²æ”¾ç½®æ–¼ä¼ºæœå™¨ã€‚");
        const templateBuffer = await response.arrayBuffer();

        // 2. æ”¶é›†æŸ¥é©—é …ç›®æ•¸æ“š
        const tableData = [];
        let count = 0;
        document.querySelectorAll('.form-panel > div').forEach(sec => {
            const titleEl = sec.querySelector('.group-title');
            if(!titleEl) return;
            const title = titleEl.innerText;
            const checks = sec.querySelectorAll('input[type="checkbox"]:checked');
            checks.forEach(chk => {
                if (chk.parentElement.style.display === 'none') return;
                count++;
                const inputEl = document.getElementById(`txt_${chk.value}`);
                tableData.push({
                    no: count,
                    proc: title,
                    item: inputEl ? inputEl.value : "",
                    std: inputEl?.nextElementSibling?.innerText || ""
                });
            });
        });

        // 3. é…ç½®åœ–ç‰‡æ¨¡çµ„ (å¼·åˆ¶åœ–ç‰‡å¯¬åº¦ç‚º 15.7cmï¼Œç´„ 593 åƒç´ )
        const imageOptions = {
            centered: true,
            getImage: function(tagValue) {
                return Uint8Array.from(atob(tagValue.split(",")[1]), c => c.charCodeAt(0));
            },
            getSize: function() {
                return [593, 800]; // å¯¬åº¦å›ºå®šç‚º 15.7cm
            }
        };
        const imageModule = new window.ImageModule(imageOptions);

        // 4. ä½¿ç”¨ PizZip èˆ‡ Docxtemplater (æ˜ç¢ºä½¿ç”¨ window ç‰©ä»¶èª¿ç”¨)
        const zip = new window.PizZip(templateBuffer);
        const doc = new window.docxtemplater(zip, {
            modules: [imageModule],
            paragraphLoop: true,
            linebreaks: true,
        });

        // 5. æ¸²æŸ“æ•¸æ“š (æ­¤èˆ‰æœƒä¿ç•™åŸå§‹æª”æ¡ˆçš„å¢ç›Šé›†èˆ‡ W æ¨£å¼)
        doc.render({
            minor: selectedMinor,
            flowchart: imgData, 
            table: tableData
        });

        // 6. ç”¢å‡ºäºŒé€²ä½æª”æ¡ˆ
        const out = doc.getZip().generate({
            type: "blob",
            mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
        });

        // 7. ä¸‹è¼‰æª”æ¡ˆ
        saveAs(out, `${selectedMinor}_æ–½å·¥æŠ½æŸ¥ç´€éŒ„è¡¨.docx`);
        btn.innerText = originalText;

    } catch (error) {
        console.error(error);
        alert("ç”Ÿæˆå¤±æ•—ï¼š" + error.message);
        btn.innerText = originalText;
    }
}
</script>
</body>
</html>



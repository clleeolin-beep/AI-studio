<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ–½å·¥è¡¨å–®ç”Ÿæˆå™¨ (V35 ç„¡æ ¼å¼ç²¾æº–ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root { --primary: #2c3e50; --bg: #f4f7f6; --accent: #27ae60; --blue: #2980b9; --orange: #e67e22; }
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .header { background: #fff; padding: 10px 25px; border-bottom: 2px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .main { flex: 1; display: flex; padding: 20px; gap: 20px; overflow: hidden; }
        .form-panel { width: 380px; background: #fff; padding: 20px; overflow-y: auto; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); flex-shrink: 0; }
        .preview-panel { flex: 1; background: #95a5a6; padding: 30px; overflow: auto; display: flex; justify-content: center; align-items: flex-start; }

        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-weight: bold; margin-bottom: 5px; color: var(--primary); }
        .input-group input, .input-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn-group { display: flex; gap: 8px; }
        .btn { padding: 8px 12px; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; }
        .btn-green { background: var(--accent); } .btn-blue { background: var(--blue); } .btn-orange { background: var(--orange); }

        .flowchart-container { 
            width: 15.7cm; background: #fff; padding: 40px 30px; box-sizing: border-box; 
            display: flex; flex-direction: column; align-items: stretch;
            font-family: "DFKai-SB", "æ¨™æ¥·é«”", serif; box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }
        .flow-row { display: flex; width: 100%; align-items: center; position: relative; min-height: 55px; }
        .node-col { width: 140px; position: relative; display: flex; flex-direction: column; align-items: center; flex-shrink: 0; align-self: stretch; }
        .v-line { position: absolute; left: 50%; transform: translateX(-50%); width: 1.5px; background: #000; z-index: 1; top: 0; bottom: 0; }
        .line-start { top: 50% !important; } .line-end { bottom: 50% !important; }
        .node-wrapper { position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; padding: 5px 0; }
        .node-box { width: 110px; padding: 6px 2px; border: 1.5px solid #000; text-align: center; background: #fff; font-weight: bold; font-size: 14pt; box-sizing: border-box; }
        .node-box.oval { border-radius: 40px; }
        .arrow-head { width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 10px solid #000; margin-bottom: -1px; background: #fff; }
        .detail-col { flex: 1; display: flex; align-items: center; max-width: calc(15.7cm - 170px); align-self: stretch; }
        .h-line { width: 25px; border-top: 1.5px dashed #000; flex-shrink: 0; }
        .detail-box { border: 1.5px dashed #000; padding: 6px 10px; font-size: 12px; background: #fff; line-height: 1.3; display: inline-block; max-width: 100%; white-space: normal; word-break: break-all; text-align: left; }
    </style>
</head>
<body>

<div class="header">
    <h3 style="margin:0;">ğŸ—ï¸ æ–½å·¥è¡¨å–®ç”Ÿæˆå™¨ (V35 ç„¡æ ¼å¼ç‰ˆ)</h3>
    <div class="btn-group">
        <button class="btn btn-blue" onclick="exportFlow()">ğŸ“¥ æµç¨‹åœ–</button>
        <button class="btn btn-green" onclick="exportStandard()">ğŸ“‹ æ¨™æº–è¡¨</button>
        <button class="btn btn-orange" onclick="exportRecord()">ğŸ“ ç´€éŒ„è¡¨</button>
    </div>
</div>

<div class="main">
    <div class="form-panel">
        <div class="input-group">
            <label>å·¥ç¨‹åç¨±ï¼š</label>
            <input type="text" id="projName" value="ä¸­å’Œå€éŒ¦å’Œé‹å‹•å…¬åœ’æ•´é«”è¦åŠƒæ”¹å–„å·¥ç¨‹">
        </div>
        <div class="input-group">
            <label>åˆ†é …å·¥ç¨‹é¸æ“‡ï¼š</label>
            <select id="minorSelect" onchange="loadForm()"></select>
        </div>
        <hr>
        <div id="formContainer">æ­£åœ¨è®€å–è³‡æ–™...</div>
    </div>
    <div class="preview-panel">
        <div id="flowchart-canvas" class="flowchart-container"></div>
    </div>
</div>

<script>
    const SS_ID = "1tCW1yzvBnzoQv2mAcLhAWcKOTe8mrOkyavWHaXRii3U";
    let rawData = [];

    document.addEventListener("DOMContentLoaded", () => {
        window.loader = (json) => {
            if (!json.table) return;
            rawData = json.table.rows.map(r => ({
                stage: r.c[3]?.v || "", minor: r.c[1]?.v || "", node: r.c[4]?.v || "",
                item: r.c[5]?.v || "", std: r.c[6]?.v || "", timing: r.c[7]?.v || "",
                method: r.c[8]?.v || "", freq: r.c[9]?.v || "", failProc: r.c[10]?.v || ""
            })).filter(r => r.node && r.node !== "æ–½å·¥æµç¨‹");
            const minors = [...new Set(rawData.map(r => r.minor))];
            document.getElementById('minorSelect').innerHTML = minors.map(m => `<option value="${m}">${m}</option>`).join('');
            loadForm();
        };
        const s = document.createElement('script');
        s.src = `https://docs.google.com/spreadsheets/d/${SS_ID}/gviz/tq?tqx=responseHandler:loader`;
        document.body.appendChild(s);
    });

    function loadForm() {
        const sel = document.getElementById('minorSelect').value;
        const groups = {};
        rawData.filter(r => r.minor === sel).forEach(r => {
            if (!groups[r.node]) groups[r.node] = [];
            if (r.item) groups[r.node].push(r);
        });
        document.getElementById('formContainer').innerHTML = Object.keys(groups).map(node => `
            <div class="group-item">
                <strong style="color:var(--primary); font-size:14px;">${node}</strong>
                ${groups[node].map(r => `<label style="display:flex; align-items:start; gap:5px; font-size:12px; margin-top:4px;"><input type="checkbox" class="chk" data-info='${JSON.stringify(r).replace(/'/g, "&apos;")}' checked onchange="updatePreview()"><span>${r.item}</span></label>`).join('')}
            </div>
        `).join('');
        updatePreview();
    }

    function createRow(txt, items, lineCls, shape, forceArrow = false) {
        const row = document.createElement('div'); row.className = 'flow-row';
        const hasArrow = (lineCls !== 'line-start' || forceArrow);
        let detailHtml = items.length ? `<div class="h-line"></div><div class="detail-box">${items.map((it, i) => `${i + 1}.${it}`).join('<br>')}</div>` : '';
        row.innerHTML = `<div class="node-col"><div class="v-line ${lineCls}"></div><div class="node-wrapper">${hasArrow ? '<div class="arrow-head"></div>' : '<div style="height:10px;"></div>'}<div class="node-box ${shape}">${txt}</div></div></div><div class="detail-col">${detailHtml}</div>`;
        return row;
    }

    function updatePreview() {
        const canvas = document.getElementById('flowchart-canvas'); canvas.innerHTML = '';
        const chks = Array.from(document.querySelectorAll('.chk:checked'));
        const flow = new Map();
        chks.forEach(c => {
            const data = JSON.parse(c.dataset.info);
            if(!flow.has(data.node)) flow.set(data.node, []);
            flow.get(data.node).push(data.item);
        });
        if(flow.size === 0) return;
        canvas.appendChild(createRow("æº–å‚™", [], "line-start", "oval"));
        flow.forEach((items, node) => canvas.appendChild(createRow(node, items, "v-line", "rect")));
        canvas.appendChild(createRow("å®Œæˆ", [], "line-end", "oval"));
    }

    async function exportFlow() {
        const canvas = document.getElementById('flowchart-canvas');
        const img = await html2canvas(canvas, { scale: 3, useCORS: true });
        const selMinor = document.getElementById('minorSelect').value;
        const html = `<html><body style="font-family:æ¨™æ¥·é«”; text-align:center;"><h2>æ–½å·¥æŠ½æŸ¥ç´€éŒ„è¡¨ (æµç¨‹åœ–)</h2><img src="${img.toDataURL()}" width="590"><p>åœ– 7-1 ${selMinor} æ–½å·¥æŠ½æŸ¥æµç¨‹åœ–</p></body></html>`;
        saveAs(new Blob(['\ufeff' + html], { type: 'application/msword' }), `${selMinor}_æ–½å·¥æµç¨‹åœ–.doc`);
    }

    function exportStandard() {
        const selMinor = document.getElementById('minorSelect').value;
        const selectedItems = Array.from(document.querySelectorAll('.chk:checked')).map(c => JSON.parse(c.dataset.info));

        let currentStage = ''; let currentNode = ''; let tableRows = '';
        selectedItems.forEach((r, i) => {
            let stageTd = ''; let nodeTd = '';
            if (r.stage !== currentStage) {
                stageTd = `<td rowspan="${selectedItems.filter(x => x.stage === r.stage).length}" style="border:1px solid black; text-align:center;">${r.stage}</td>`;
                currentStage = r.stage;
            }
            if (r.node !== currentNode) {
                nodeTd = `<td rowspan="${selectedItems.filter(x => x.stage === r.stage && x.node === r.node).length}" style="border:1px solid black; text-align:center;">${r.node}</td>`;
                currentNode = r.node;
            }
            tableRows += `<tr>${stageTd}${nodeTd}<td style="border:1px solid black;">${r.item}</td><td style="border:1px solid black;">${r.std.replace(/\n/g, '<br>')}</td><td style="border:1px solid black; text-align:center;">${r.timing.includes('æ–½å·¥ä¸­') ? '<span style="color:red;">ï¼Š</span>' : ''}${r.timing}</td><td style="border:1px solid black; text-align:center;">${r.method}</td><td style="border:1px solid black; text-align:center;">${r.freq}</td><td style="border:1px solid black; text-align:center;">${r.failProc}</td><td style="border:1px solid black; text-align:center;">æ–½å·¥æŠ½æŸ¥ç´€éŒ„</td><td style="border:1px solid black;"></td></tr>`;
        });

        const html = `<html><head><meta charset='utf-8'><style>@page Section2 { size: 841.9pt 595.3pt; mso-page-orientation: landscape; margin: 36pt; } div.Section2 { page: Section2; } body { font-family: "æ¨™æ¥·é«”"; } table { width: 100%; border-collapse: collapse; } th, td { border: 1px solid black; padding: 4px; font-size: 10pt; }</style></head>
            <body><div class="Section2"><h2 align="center">è¡¨ 7-5 ${selMinor} æ–½å·¥æŠ½æŸ¥æ¨™æº–è¡¨</h2><table><tr><th colspan="10" style="border:1px solid black; font-size:12pt; padding:8px; text-align:center;">æ··å‡åœŸå·¥ç¨‹æ–½å·¥å“è³ªæŠ½æŸ¥æ¨™æº–</th></tr><tr style="font-weight:bold;"><th>æ–½å·¥éšæ®µ</th><th>æ–½å·¥æµç¨‹</th><th>ç®¡ç†é …ç›®</th><th>æŠ½æŸ¥æ¨™æº–</th><th>æ™‚æ©Ÿ</th><th>æ–¹æ³•</th><th>é »ç‡</th><th>ä¸åˆæ ¼è™•ç†</th><th>ç´€éŒ„</th><th>å‚™è¨»</th></tr>${tableRows}</table><p style="color:red; font-size:10pt;">ï¼Šç‚ºæª¢é©—åœç•™é»(æˆ–è¨»æ˜ï¼šæŠ½æŸ¥æ™‚æ©Ÿå…§é™¤æ¨™è¨»ç‚ºã€Œä¸å®šæœŸã€å¤–ï¼Œé¤˜çš†ç‚ºæª¢é©—åœç•™é»)</p></div></body></html>`;
        saveAs(new Blob(['\ufeff' + html], { type: 'application/msword' }), `${selMinor}_æ–½å·¥æŠ½æŸ¥æ¨™æº–è¡¨.doc`);
    }

    function exportRecord() {
        const pName = document.getElementById('projName').value;
        const selMinor = document.getElementById('minorSelect').value;
        const selectedItems = Array.from(document.querySelectorAll('.chk:checked')).map(c => JSON.parse(c.dataset.info));

        let currentStage = ''; let currentNode = ''; let tableRows = '';
        selectedItems.forEach((r, i) => {
            let stageTd = ''; let nodeTd = '';
            if (r.stage !== currentStage) {
                stageTd = `<td rowspan="${selectedItems.filter(x => x.stage === r.stage).length}" style="border:1px solid black; text-align:center; font-weight:bold;">${r.stage}</td>`;
                currentStage = r.stage;
            }
            if (r.node !== currentNode) {
                nodeTd = `<td rowspan="${selectedItems.filter(x => x.stage === r.stage && x.node === r.node).length}" style="border:1px solid black; text-align:center;">${r.node}</td>`;
                currentNode = r.node;
            }
            tableRows += `<tr>${stageTd}${nodeTd}<td style="border:1px solid black; padding:5px;">${r.item}</td><td style="border:1px solid black; padding:5px;">${r.std.replace(/\n/g, '<br>')}</td><td style="border:1px solid black; width:80pt;"></td><td style="border:1px solid black; width:35pt;"></td></tr>`;
        });

        const header = `<table style="width:100%; border-collapse:collapse; border:1px solid black; margin-bottom:10px;"><tr><td style="border:1px solid black; width:18%; text-align:center;">å·¥ç¨‹åç¨±</td><td colspan="5" style="border:1px solid black; padding-left:5px; color:red;">${pName}</td></tr><tr><td style="border:1px solid black; text-align:center;">åˆ†é …å·¥ç¨‹åç¨±</td><td colspan="5" style="border:1px solid black; padding-left:5px; color:red;">${selMinor}</td></tr><tr><td style="border:1px solid black; text-align:center;">æª¢æŸ¥ä½ç½®</td><td style="border:1px solid black; width:30%;"></td><td style="border:1px solid black; width:15%; text-align:center;">æª¢æŸ¥æ—¥æœŸ</td><td colspan="3" style="border:1px solid black; text-align:center;"> å¹´ æœˆ æ—¥</td></tr><tr><td style="border:1px solid black; text-align:center;">æª¢æŸ¥æ™‚æ©Ÿ</td><td colspan="5" style="border:1px solid black; padding-left:5px;">â–¡æ–½å·¥å‰ â–¡æ–½å·¥ä¸­æª¢æŸ¥ â–¡æ–½å·¥å®Œæˆæª¢æŸ¥</td></tr><tr><td style="border:1px solid black; text-align:center;">æª¢æŸ¥çµæœ</td><td colspan="5" style="border:1px solid black; padding-left:5px;">â—‹æª¢æŸ¥åˆæ ¼ â•³æœ‰ç¼ºå¤±éœ€æ”¹æ­£ ï¼ç„¡æ­¤æª¢æŸ¥é …ç›®</td></tr></table>`;

        const html = `<html><head><meta charset='utf-8'><style>body { font-family: "æ¨™æ¥·é«”"; } table { width: 100%; border-collapse: collapse; } th, td { border: 1px solid black; padding: 4px; font-size: 11pt; }</style></head>
            <body><h2 align="center">æ–½å·¥æŠ½æŸ¥ç´€éŒ„è¡¨</h2><div align="right">ç·¨è™Ÿï¼š__________</div>${header}
                <table><tr style="font-weight:bold;"><th colspan="3" style="width:180pt; border:1px solid black;">æª¢æŸ¥é …ç›®</th><th style="border:1px solid black;">æŠ½æŸ¥æ¨™æº–(å®šé‡å®šæ€§)</th><th width="80pt" style="border:1px solid black;">å¯¦éš›æŠ½æŸ¥æƒ…å½¢</th><th width="40pt" style="border:1px solid black;">çµæœ</th></tr>${tableRows}</table>
                <p style="font-size:10pt; margin-top:5px;">å‚™è¨»ï¼š1. åˆæ ¼è€…è¨»æ˜ã€Œâ—‹ã€ï¼Œä¸åˆæ ¼è€…è¨»æ˜ã€Œâ•³ã€ï¼Œç„¡éœ€æª¢æŸ¥é …ç›®æ‰“ã€Œ/ã€ã€‚</p>
                <div style="margin-top:15px;">ç›£é€ ä¸»ç®¡ï¼š____________________  æ´¾é§ç¾å ´äººå“¡ç°½åï¼š____________________</div>
            </body></html>`;
        saveAs(new Blob(['\ufeff' + html], { type: 'application/msword' }), `${selMinor}_æ–½å·¥æŠ½æŸ¥ç´€éŒ„è¡¨.doc`);
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AI Lab - 標案進度管理工具 (專業版)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --header-bg: #7d9e6d;
            --header-dark: #6b8a5d;
            --tick-width: 37.8px; 
        }
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f0f0; padding: 20px; user-select: none; }
        .toolbar { margin-bottom: 15px; display: flex; gap: 10px; align-items: center; }
        .btn { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; font-size: 14px; transition: 0.2s; }
        .btn-save { background-color: #3498db; }
        .btn-load { background-color: #9b59b6; }
        .btn-img { background-color: #e67e22; }
        .btn:hover { filter: brightness(1.1); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .gantt-scroll-wrapper { overflow-x: auto; background: white; padding: 25px; border-radius: 12px; }
        .gantt-capture-area { display: inline-table; background: white; padding: 0; margin: 0; border: none; position: relative; }

        table { border-collapse: collapse; table-layout: fixed; width: auto; background: white; border: 1px solid #ccc; margin: 0; }
        th, td { border: 1px solid #ccc; font-size: 13px; height: 42px; position: relative; padding: 0; box-sizing: border-box; }
        .header-row { background-color: var(--header-bg); color: white; }

        .col-resizer { position: absolute; right: 0; top: 0; width: 4px; height: 100%; cursor: col-resize; z-index: 1000; border-right: 2px solid var(--header-dark); opacity: 0.4; }
        
        .ruler { display: flex; background: #f9f9f9; border-left: 1px solid #ccc; border-right: 1px solid #ccc; font-size: 11px; box-sizing: border-box; }
        .ruler-tick { flex: 0 0 var(--tick-width); border-right: 1px solid #ddd; text-align: center; line-height: 30px; box-sizing: border-box; overflow: hidden; }
        .ruler-tick:last-child { border-right: none; width: var(--tick-width); }

        .phase-row { background: #e8f0e0; font-weight: bold; text-align: left; padding-left: 10px; cursor: move; }
        .item-name { padding: 0 10px; display: block; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; line-height: 42px; text-align: left; cursor: move; }
        .contract-cell { text-align: center; color: #2980b9; font-weight: bold; cursor: pointer; text-decoration: underline; }
        
        .timeline-cell { padding: 0; background-image: linear-gradient(to right, #eee 1px, transparent 1px); background-size: var(--tick-width) 100%; position: relative; overflow: visible; }
        .bar { position: absolute; height: 26px; background: #a2c65a; border: 1px solid #7a9643; border-radius: 4px; top: 50%; transform: translateY(-50%); display: flex; align-items: center; justify-content: center; font-size: 11px; z-index: 10; cursor: grab; padding: 0 5px; box-sizing: border-box; }
        .resizer { width: 10px; height: 100%; position: absolute; right: 0; cursor: col-resize; z-index: 11; }
        
        /* 里程碑樣式：增加 5px 的偏移量 */
        .milestone-dot { position: absolute; width: 10px; height: 10px; background: black; border-radius: 50%; top: 50%; transform: translate(5px, -50%); z-index: 15; }

        .dragging { opacity: 0.3; background: #fffde7 !important; }
        .drop-target { border-top: 3px solid #3498db !important; }

        .context-menu { position: fixed; background: white; border: 1px solid #ccc; box-shadow: 2px 2px 12px rgba(0,0,0,0.2); display: none; z-index: 2000; border-radius: 6px; overflow: hidden; }
        .context-menu button { display: block; width: 100%; padding: 12px 20px; border: none; background: none; text-align: left; cursor: pointer; font-size: 14px; }
        .context-menu button:hover { background: #f5f5f5; }
    </style>
</head>
<body>

<div class="toolbar">
    <button class="btn btn-save" onclick="saveData()">💾 下載 JSON 存檔</button>
    <button class="btn btn-load" onclick="document.getElementById('fileInput').click()">📂 匯入存檔</button>
    <button class="btn btn-img" onclick="exportImage()">🖼️ 匯出 PNG (無溢出)</button>
    <input type="file" id="fileInput" style="display:none" accept=".json" onchange="loadData(event)">
</div>

<div class="gantt-scroll-wrapper">
    <div id="captureArea" class="gantt-capture-area">
        <div id="topRuler" class="ruler" style="height: 30px; border-top: 1px solid #ccc;"></div>
        <table id="ganttTable">
            <thead>
                <tr class="header-row">
                    <th id="col-name" style="width: 250px;">階段 / 項目 <div class="col-resizer" onmousedown="startColResize(event, 'col-name')"></div></th>
                    <th id="col-contract" style="width: 150px;">日曆天 <div class="col-resizer" onmousedown="startColResize(event, 'col-contract')"></div></th>
                    <th id="col-timeline">累計天數進度區間</th>
                </tr>
            </thead>
            <tbody id="ganttBody"></tbody>
        </table>
        <div id="bottomRuler" class="ruler" style="height: 35px; border-top: 2px solid #666; border-bottom: 1px solid #ccc;"></div>
    </div>
</div>

<div id="menu" class="context-menu">
    <button onclick="doAction('addItem')">➕ 新增項目</button>
    <button onclick="doAction('addPhase')">📂 新增階段</button>
    <button onclick="doAction('toggleMilestone')" id="btnMs">⚫ 切換里程碑</button>
    <button onclick="doAction('editName')">✏️ 修改名稱</button>
    <button onclick="doAction('delete')" style="color:red;">🗑️ 刪除此項</button>
</div>

<script>
    // 預設匯入圖片所有資料
    let data = [
        { name: '【階段一：啟動與準備】', items: [
            { name: '1.1服務實施計畫書', contract: '簽約 +14', start: 0, duration: 14, ms: false },
            { name: '1.2實施簽證執行計畫', contract: '簽約 +14', start: 0, duration: 14, ms: false },
            { name: '1.3專業責任險投保', contract: '簽約 +30', start: 0, duration: 30, ms: false },
            { name: '1.4 服務人員名冊與投保資料', contract: '機關指定日', start: 30, duration: 0, ms: true },
            { name: '1.5工作坊企劃書', contract: '簽約 +30', start: 0, duration: 30, ms: true }
        ]},
        { name: '【階段二：調查與基設】', items: [
            { name: '2.1工作坊成果報告', contract: '完成工作坊30+', start: 60, duration: 30, ms: false },
            { name: '2.2測量與樹木調查', contract: '決標 +60', start: 0, duration: 60, ms: false },
            { name: '2.3地質鑽探資料', contract: '決標 +75', start: 0, duration: 75, ms: false },
            { name: '2.4基設初稿', contract: '決標 +90', start: 0, duration: 90, ms: true },
            { name: '2.5基設成果報告書', contract: '基設核定+30', start: 120, duration: 30, ms: false }
        ]},
        { name: '【階段三：審議與許可】', items: [
            { name: '3.1水保與樹保送審', contract: '基設核定+30', start: 150, duration: 30, ms: false },
            { name: '3.2都審掛號 (UDR)', contract: '基設核定+14', start: 150, duration: 14, ms: true }
        ]},
        { name: '【階段四：細部與招標】', items: [
            { name: '4.1 細設圖文', contract: '都審核定+75', start: 210, duration: 75, ms: true },
            { name: '4.2 細設成果報告', contract: '細設核定+40', start: 300, duration: 40, ms: false },
            { name: '4.3 建雜照申請', contract: '細設核定+20', start: 300, duration: 20, ms: false },
            { name: '4.4 五大管線申請', contract: '建雜照核定+30', start: 330, duration: 30, ms: true }
        ]},
        { name: '【階段五：監造與結案】', items: [
            { name: '5.1 監造計畫書', contract: '工程決標+15', start: 390, duration: 15, ms: true },
            { name: '5.2 竣工圖', contract: '完工 +30', start: 450, duration: 30, ms: false }
        ]}
    ];

    let dragSource = null;
    let mTarget = null;

    function render() {
        const tbody = document.getElementById('ganttBody');
        tbody.innerHTML = '';
        let maxEnd = 0;
        data.forEach(p => p.items.forEach(i => maxEnd = Math.max(maxEnd, i.start + i.duration)));
        const tickCount = Math.ceil((maxEnd + 1) / 30) || 1;
        const timelineWidthPx = tickCount * 37.8;
        document.getElementById('col-timeline').style.width = timelineWidthPx + 'px';

        data.forEach((phase, pIdx) => {
            const ptr = document.createElement('tr');
            ptr.className = 'phase-row'; ptr.draggable = true;
            ptr.innerHTML = `<td colspan="3" onclick="showMenu(event, 'phase', ${pIdx})">${phase.name}</td>`;
            ptr.ondragstart = (e) => { dragSource = { type: 'phase', pIdx }; e.target.classList.add('dragging'); };
            ptr.ondragover = (e) => { e.preventDefault(); ptr.classList.add('drop-target'); };
            ptr.ondragleave = () => ptr.classList.remove('drop-target');
            ptr.ondrop = (e) => handleDrop(e, 'phase', pIdx);
            ptr.ondragend = () => render();
            tbody.appendChild(ptr);

            phase.items.forEach((item, iIdx) => {
                const tr = document.createElement('tr');
                const left = (item.start / 30) * 37.8;
                const width = (item.duration / 30) * 37.8;
                tr.innerHTML = `
                    <td onclick="showMenu(event, 'item', ${pIdx}, ${iIdx})"><span class="item-name" draggable="true">${item.name}</span></td>
                    <td class="contract-cell" onclick="editContract(${pIdx}, ${iIdx})">${item.contract}</td>
                    <td class="timeline-cell" style="width:${timelineWidthPx}px;">
                        <div class="bar" style="left:${left}px; width:${width}px" onmousedown="startBarAction(event, ${pIdx}, ${iIdx})">
                            ${item.duration > 0 ? item.duration + 'd' : ''}
                            <div class="resizer" onmousedown="startBarAction(event, ${pIdx}, ${iIdx}, true)"></div>
                        </div>
                        ${item.ms ? `<div class="milestone-dot" style="left:${left + width}px"></div>` : ''}
                    </td>`;
                const span = tr.querySelector('.item-name');
                span.ondragstart = (e) => { dragSource = { type: 'item', pIdx, iIdx }; tr.classList.add('dragging'); };
                tr.ondragover = (e) => { e.preventDefault(); tr.classList.add('drop-target'); };
                tr.ondragleave = () => tr.classList.remove('drop-target');
                tr.ondrop = (e) => handleDrop(e, 'item', pIdx, iIdx);
                span.ondragend = () => render();
                tbody.appendChild(tr);
            });
        });
        updateRulers(tickCount);
    }

    function handleDrop(e, targetType, targetPIdx, targetIIdx = null) {
        e.preventDefault(); if (!dragSource) return;
        if (dragSource.type === 'phase' && targetType === 'phase') {
            const moved = data.splice(dragSource.pIdx, 1)[0]; data.splice(targetPIdx, 0, moved);
        } else if (dragSource.type === 'item') {
            const movedItem = data[dragSource.pIdx].items.splice(dragSource.iIdx, 1)[0];
            const insIdx = (targetIIdx === null) ? 0 : targetIIdx;
            data[targetPIdx].items.splice(insIdx, 0, movedItem);
        }
        dragSource = null; render();
    }

    function startBarAction(e, pIdx, iIdx, resize=false) {
        e.stopPropagation(); const item = data[pIdx].items[iIdx], sX = e.clientX, iS = item.start, iD = item.duration;
        document.onmousemove = (ev) => {
            const delta = (ev.clientX - sX) / (37.8 / 30);
            if (resize) item.duration = Math.max(0, Math.round(iD + delta));
            else item.start = Math.max(0, Math.round((iS + delta) / 5) * 5);
            render();
        };
        document.onmouseup = () => document.onmousemove = null;
    }

    function startColResize(e, id) {
        e.stopPropagation(); let obj = document.getElementById(id), sX = e.clientX, sW = obj.offsetWidth;
        document.onmousemove = (ev) => { obj.style.width = Math.max(60, sW + (ev.clientX - sX)) + 'px'; render(); };
        document.onmouseup = () => document.onmousemove = null;
    }

    function showMenu(e, type, pIdx, iIdx = null) {
        e.stopPropagation(); mTarget = { type, pIdx, iIdx };
        const menu = document.getElementById('menu');
        menu.style.display = 'block'; menu.style.left = e.clientX + 'px'; menu.style.top = e.clientY + 'px';
        document.getElementById('btnMs').style.display = (type === 'item') ? 'block' : 'none';
    }

    function doAction(act) {
        if (!mTarget) return;
        const { type, pIdx, iIdx } = mTarget;
        if (act === 'addItem') { const n = prompt("工項名稱:", "新工項"); if(n) data[pIdx].items.push({ name: n, contract: "30", start: 0, duration: 30, ms: false }); }
        else if (act === 'delete') { if(confirm("確定刪除?")) (type==='phase') ? data.splice(pIdx, 1) : data[pIdx].items.splice(iIdx, 1); }
        else if (act === 'editName') { const old = (type==='phase') ? data[pIdx].name : data[pIdx].items[iIdx].name; const n = prompt("修改名稱:", old); if(n) (type==='phase') ? data[pIdx].name = n : data[pIdx].items[iIdx].name = n; }
        else if (act === 'addPhase') { const n = prompt("階段名稱:", "新階段"); if(n) data.splice(pIdx + 1, 0, { name: n, items: [] }); }
        else if (act === 'toggleMilestone') { data[pIdx].items[iIdx].ms = !data[pIdx].items[iIdx].ms; }
        document.getElementById('menu').style.display = 'none'; render();
    }

    function editContract(pIdx, iIdx) {
        const res = prompt("編輯日曆天文字:", data[pIdx].items[iIdx].contract);
        if (res !== null) { data[pIdx].items[iIdx].contract = res; render(); }
    }

    function updateRulers(count) {
        const headerW = document.getElementById('col-name').offsetWidth + document.getElementById('col-contract').offsetWidth;
        const timelineW = count * 37.8;
        let t = '', b = '';
        for (let i = 0; i <= count; i++) {
            t += `<div class="ruler-tick">${i * 30}</div>`;
            if (i < count) b += `<div class="ruler-tick" style="background:#eee">${i+1}月</div>`;
        }
        document.getElementById('topRuler').style.width = (headerW + timelineW) + 'px';
        document.getElementById('topRuler').innerHTML = `<div style="width:${headerW}px; border-right:1px solid #ccc; flex-shrink:0;"></div><div style="display:flex; width:${timelineW}px;">${t}</div>`;
        document.getElementById('bottomRuler').style.width = (headerW + timelineW) + 'px';
        document.getElementById('bottomRuler').innerHTML = `<div style="width:${headerW}px; border-right:1px solid #ccc; flex-shrink:0; text-align:center; line-height:35px; font-weight:bold;">月份累計</div><div style="display:flex; width:${timelineW}px;">${b}</div>`;
    }

    function saveData() {
        const config = { nameW: document.getElementById('col-name').style.width, contractW: document.getElementById('col-contract').style.width };
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify({data, config})], {type:"application/json"})); a.download = `標案存檔.json`; a.click();
    }

    function loadData(e) {
        const reader = new FileReader();
        reader.onload = (ev) => { const d = JSON.parse(ev.target.result); data = d.data; if(d.config){document.getElementById('col-name').style.width=d.config.nameW; document.getElementById('col-contract').style.width=d.config.contractW;} render(); };
        reader.readAsText(e.target.files[0]);
    }

    function exportImage() {
        const area = document.getElementById('captureArea');
        html2canvas(area, { scale: 2, backgroundColor: "#ffffff", width: area.offsetWidth, height: area.offsetHeight }).then(canvas => {
            const link = document.createElement('a'); link.download = `標案甘特圖.png`; link.href = canvas.toDataURL(); link.click();
        });
    }

    window.onclick = () => document.getElementById('menu').style.display = 'none';
    window.onload = render;
</script>
</body>
</html>
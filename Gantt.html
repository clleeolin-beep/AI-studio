<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AI Lab - æ¨™æ¡ˆé€²åº¦ç®¡ç†å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --header-bg: #7d9e6d;
            --header-dark: #6b8a5d;
            --tick-width: 37.8px; 
        }
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f0f0; padding: 20px; user-select: none; }
        .toolbar { margin-bottom: 15px; display: flex; gap: 10px; align-items: center; }
        .btn { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; font-size: 14px; transition: 0.2s; }
        .btn-save { background-color: #3498db; }
        .btn-load { background-color: #9b59b6; }
        .btn-img { background-color: #e67e22; }
        .btn:hover { filter: brightness(1.1); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .gantt-scroll-wrapper { overflow-x: auto; background: white; padding: 25px; border-radius: 12px; }
        .gantt-capture-area { display: inline-table; background: white; padding: 0; margin: 0; border: none; position: relative; }

        table { border-collapse: collapse; table-layout: fixed; width: auto; background: white; border: 1px solid #ccc; margin: 0; }
        th, td { border: 1px solid #ccc; font-size: 13px; height: 42px; position: relative; padding: 0; box-sizing: border-box; }
        .header-row { background-color: var(--header-bg); color: white; }

        .col-resizer { position: absolute; right: 0; top: 0; width: 4px; height: 100%; cursor: col-resize; z-index: 1000; border-right: 2px solid var(--header-dark); opacity: 0.4; }
        
        .ruler { display: flex; background: #f9f9f9; border-left: 1px solid #ccc; border-right: 1px solid #ccc; font-size: 11px; box-sizing: border-box; }
        .ruler-tick { flex: 0 0 var(--tick-width); border-right: 1px solid #ddd; text-align: center; line-height: 30px; box-sizing: border-box; overflow: hidden; }
        .ruler-tick:last-child { border-right: none; width: var(--tick-width); }

        .phase-row { font-weight: bold; text-align: left; padding-left: 10px; cursor: move; color: white; }
        .item-name { padding: 0 10px; display: block; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; line-height: 42px; text-align: left; cursor: move; }
        .contract-cell { text-align: center; color: #2980b9; font-weight: bold; cursor: pointer; text-decoration: underline; }
        
        .timeline-cell { padding: 0; background-image: linear-gradient(to right, #eee 1px, transparent 1px); background-size: var(--tick-width) 100%; position: relative; overflow: visible; }
        .bar { position: absolute; height: 24px; border-radius: 4px; top: 50%; transform: translateY(-50%); display: flex; align-items: center; justify-content: center; font-size: 11px; z-index: 10; cursor: grab; padding: 0 5px; box-sizing: border-box; color: white; border: 1px solid rgba(0,0,0,0.1); }
        .resizer { width: 10px; height: 100%; position: absolute; right: 0; cursor: col-resize; z-index: 11; }
        
        .milestone-dot { position: absolute; width: 10px; height: 10px; background: black; border-radius: 50%; top: 50%; transform: translate(5px, -50%); z-index: 15; }

        .dragging { opacity: 0.3; background: #fffde7 !important; }
        .drop-target { border-top: 3px solid #3498db !important; }

        .context-menu { position: fixed; background: white; border: 1px solid #ccc; box-shadow: 2px 2px 12px rgba(0,0,0,0.2); display: none; z-index: 2000; border-radius: 6px; overflow: hidden; }
        .context-menu button { display: block; width: 100%; padding: 12px 20px; border: none; background: none; text-align: left; cursor: pointer; font-size: 14px; }
        .context-menu button:hover { background: #f5f5f5; }
        
        #colorPicker { display: none; }
    </style>
</head>
<body>

<div class="toolbar">
    <button class="btn btn-save" onclick="saveData()">ğŸ’¾ ä¸‹è¼‰å­˜æª” (JSON)</button>
    <button class="btn btn-load" onclick="document.getElementById('fileInput').click()">ğŸ“‚ åŒ¯å…¥å­˜æª”</button>
    <button class="btn btn-img" onclick="exportImage()">ğŸ–¼ï¸ åŒ¯å‡ºåœ–ç‰‡ (PNG)</button>
    <input type="file" id="fileInput" style="display:none" accept=".json" onchange="loadData(event)">
    <input type="color" id="colorPicker" onchange="applyColor(event)">
</div>

<div class="gantt-scroll-wrapper">
    <div id="captureArea" class="gantt-capture-area">
        <div id="topRuler" class="ruler" style="height: 30px; border-top: 1px solid #ccc;"></div>
        <table id="ganttTable">
            <thead>
                <tr class="header-row">
                    <th id="col-name" style="width: 250px;">éšæ®µ / é …ç›® <div class="col-resizer" onmousedown="startColResize(event, 'col-name')"></div></th>
                    <th id="col-contract" style="width: 150px;">æ—¥æ›†å¤© <div class="col-resizer" onmousedown="startColResize(event, 'col-contract')"></div></th>
                    <th id="col-timeline">ç´¯è¨ˆå¤©æ•¸é€²åº¦å€é–“</th>
                </tr>
            </thead>
            <tbody id="ganttBody"></tbody>
        </table>
        <div id="bottomRuler" class="ruler" style="height: 35px; border-top: 2px solid #666; border-bottom: 1px solid #ccc;"></div>
    </div>
</div>

<div id="menu" class="context-menu">
    <button onclick="doAction('addItem')">â• æ–°å¢é …ç›®</button>
    <button onclick="doAction('addPhase')">ğŸ“‚ æ–°å¢éšæ®µ</button>
    <button onclick="document.getElementById('colorPicker').click()" id="btnColor">ğŸ¨ è¨­å®šéšæ®µé¡è‰²</button>
    <button onclick="doAction('toggleMilestone')" id="btnMs">âš« åœç•™é»ï¼šé–‹/é—œ</button>
    <button onclick="doAction('toggleBar')" id="btnBar">ğŸŸ© å·¥é …é¡¯ç¤ºï¼šé–‹/é—œ</button>
    <button onclick="doAction('editName')">âœï¸ ä¿®æ”¹åç¨±</button>
    <button onclick="doAction('delete')" style="color:red;">ğŸ—‘ï¸ åˆªé™¤æ­¤é …</button>
</div>

<script>
    // é è¨­è³‡æ–™ï¼šåŒ¯å…¥ã€Œæ¨™æ¡ˆå­˜æª” (1).jsonã€çš„å…§å®¹
    let data = [
        { "name": "ã€éšæ®µä¸€ï¼šå•Ÿå‹•èˆ‡æº–å‚™ã€‘", "color": "#e200e6", "items": [
            { "name": "1.1æœå‹™å¯¦æ–½è¨ˆç•«æ›¸", "contract": "ç°½ç´„ +14", "start": 0, "duration": 14, "ms": false, "showBar": true },
            { "name": "1.2å¯¦æ–½ç°½è­‰åŸ·è¡Œè¨ˆç•«", "contract": "ç°½ç´„ +14", "start": 0, "duration": 14, "ms": false, "showBar": true },
            { "name": "1.3å°ˆæ¥­è²¬ä»»éšªæŠ•ä¿", "contract": "ç°½ç´„ +30", "start": 0, "duration": 30, "ms": false, "showBar": true },
            { "name": "1.4 æœå‹™äººå“¡åå†Šèˆ‡æŠ•ä¿è³‡æ–™", "contract": "æ©Ÿé—œæŒ‡å®šæ—¥", "start": 30, "duration": 17, "ms": true, "showBar": true },
            { "name": "1.5å·¥ä½œåŠä¼åŠƒæ›¸", "contract": "ç°½ç´„ +30", "start": 0, "duration": 30, "ms": true, "showBar": true }
        ]},
        { "name": "ã€éšæ®µäºŒï¼šèª¿æŸ¥èˆ‡åŸºè¨­ã€‘", "color": "#3a6d9c", "items": [
            { "name": "2.1å·¥ä½œåŠæˆæœå ±å‘Š", "contract": "å®Œæˆå·¥ä½œåŠ30+", "start": 60, "duration": 30, "ms": false, "showBar": true },
            { "name": "2.2æ¸¬é‡èˆ‡æ¨¹æœ¨èª¿æŸ¥", "contract": "æ±ºæ¨™ +60", "start": 0, "duration": 60, "ms": false, "showBar": true },
            { "name": "2.3åœ°è³ªé‘½æ¢è³‡æ–™", "contract": "æ±ºæ¨™ +75", "start": 0, "duration": 75, "ms": false, "showBar": true },
            { "name": "2.4åŸºè¨­åˆç¨¿", "contract": "æ±ºæ¨™ +90", "start": 0, "duration": 90, "ms": true, "showBar": true },
            { "name": "2.5åŸºè¨­æˆæœå ±å‘Šæ›¸", "contract": "åŸºè¨­æ ¸å®š+30", "start": 120, "duration": 30, "ms": false, "showBar": true }
        ]},
        { "name": "ã€éšæ®µä¸‰ï¼šå¯©è­°èˆ‡è¨±å¯ã€‘", "color": "#6b9c3a", "items": [
            { "name": "3.1æ°´ä¿èˆ‡æ¨¹ä¿é€å¯©", "contract": "åŸºè¨­æ ¸å®š+30", "start": 150, "duration": 30, "ms": false, "showBar": true },
            { "name": "3.2éƒ½å¯©æ›è™Ÿ (UDR)", "contract": "åŸºè¨­æ ¸å®š+14", "start": 150, "duration": 14, "ms": true, "showBar": true }
        ]},
        { "name": "ã€éšæ®µå››ï¼šç´°éƒ¨èˆ‡æ‹›æ¨™ã€‘", "color": "#ff7e05", "items": [
            { "name": "4.1 ç´°è¨­åœ–æ–‡", "contract": "éƒ½å¯©æ ¸å®š+75", "start": 210, "duration": 75, "ms": true, "showBar": true },
            { "name": "4.2 ç´°è¨­æˆæœå ±å‘Š", "contract": "ç´°è¨­æ ¸å®š+40", "start": 300, "duration": 40, "ms": false, "showBar": true },
            { "name": "4.3 å»ºé›œç…§ç”³è«‹", "contract": "ç´°è¨­æ ¸å®š+20", "start": 300, "duration": 20, "ms": false, "showBar": true },
            { "name": "4.4 äº”å¤§ç®¡ç·šç”³è«‹", "contract": "å»ºé›œç…§æ ¸å®š+30", "start": 330, "duration": 30, "ms": true, "showBar": true }
        ]},
        { "name": "ã€éšæ®µäº”ï¼šç›£é€ èˆ‡çµæ¡ˆã€‘", "color": "#d41111", "items": [
            { "name": "5.1 ç›£é€ è¨ˆç•«æ›¸", "contract": "å·¥ç¨‹æ±ºæ¨™+15", "start": 390, "duration": 15, "ms": true, "showBar": true },
            { "name": "5.2 ç«£å·¥åœ–", "contract": "å®Œå·¥ +30", "start": 450, "duration": 30, "ms": false, "showBar": true }
        ]}
    ];

    let dragSource = null;
    let mTarget = null;

    function lightenColor(hex, percent) {
        if(!hex) return '#a2c65a';
        var num = parseInt(hex.replace("#",""),16),
            amt = Math.round(2.55 * percent),
            R = (num >> 16) + amt,
            G = (num >> 8 & 0x00FF) + amt,
            B = (num & 0x0000FF) + amt;
        return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 + (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255)).toString(16).slice(1);
    }

    function render() {
        const tbody = document.getElementById('ganttBody');
        tbody.innerHTML = '';
        let maxEnd = 0;
        data.forEach(p => p.items.forEach(i => maxEnd = Math.max(maxEnd, i.start + i.duration)));
        const tickCount = Math.ceil((maxEnd + 30) / 30) || 1;
        const timelineWidthPx = tickCount * 37.8;
        document.getElementById('col-timeline').style.width = timelineWidthPx + 'px';

        data.forEach((phase, pIdx) => {
            const ptr = document.createElement('tr');
            ptr.className = 'phase-row'; ptr.draggable = true;
            ptr.style.backgroundColor = phase.color || '#e8f0e0';
            ptr.innerHTML = `<td colspan="3" onclick="showMenu(event, 'phase', ${pIdx})">${phase.name}</td>`;
            
            ptr.ondragstart = (e) => { dragSource = { type: 'phase', pIdx }; e.target.classList.add('dragging'); };
            ptr.ondragover = (e) => { e.preventDefault(); ptr.classList.add('drop-target'); };
            ptr.ondragleave = () => ptr.classList.remove('drop-target');
            ptr.ondrop = (e) => handleDrop(e, 'phase', pIdx);
            ptr.ondragend = () => render();
            tbody.appendChild(ptr);

            phase.items.forEach((item, iIdx) => {
                const tr = document.createElement('tr');
                const left = (item.start / 30) * 37.8;
                const width = (item.duration / 30) * 37.8;
                const barColor = phase.color ? lightenColor(phase.color, 15) : '#a2c65a';
                
                tr.innerHTML = `
                    <td onclick="showMenu(event, 'item', ${pIdx}, ${iIdx})"><span class="item-name" draggable="true">${item.name}</span></td>
                    <td class="contract-cell" onclick="editContract(${pIdx}, ${iIdx})">${item.contract}</td>
                    <td class="timeline-cell" style="width:${timelineWidthPx}px;">
                        ${item.showBar !== false ? `
                        <div class="bar" style="left:${left}px; width:${width}px; background-color:${barColor};" onmousedown="startBarAction(event, ${pIdx}, ${iIdx})">
                            ${item.duration > 0 ? item.duration + 'd' : ''}
                            <div class="resizer" onmousedown="startBarAction(event, ${pIdx}, ${iIdx}, true)"></div>
                        </div>` : ''}
                        ${item.ms ? `<div class="milestone-dot" style="left:${left + width}px"></div>` : ''}
                    </td>`;
                const span = tr.querySelector('.item-name');
                span.ondragstart = (e) => { dragSource = { type: 'item', pIdx, iIdx }; tr.classList.add('dragging'); };
                tr.ondragover = (e) => { e.preventDefault(); tr.classList.add('drop-target'); };
                tr.ondragleave = () => tr.classList.remove('drop-target');
                tr.ondrop = (e) => handleDrop(e, 'item', pIdx, iIdx);
                span.ondragend = () => render();
                tbody.appendChild(tr);
            });
        });
        updateRulers(tickCount);
    }

    function showMenu(e, type, pIdx, iIdx = null) {
        e.stopPropagation(); mTarget = { type, pIdx, iIdx };
        const menu = document.getElementById('menu');
        menu.style.display = 'block'; menu.style.left = e.clientX + 'px'; menu.style.top = e.clientY + 'px';
        
        document.getElementById('btnMs').style.display = (type === 'item') ? 'block' : 'none';
        document.getElementById('btnBar').style.display = (type === 'item') ? 'block' : 'none';
        document.getElementById('btnColor').style.display = (type === 'phase') ? 'block' : 'none';
        
        if (type === 'item') {
            const item = data[pIdx].items[iIdx];
            document.getElementById('btnMs').innerHTML = `${item.ms ? "âœ…" : "âš«"} åœç•™é»ï¼šé–‹/é—œ`;
            document.getElementById('btnBar').innerHTML = `${item.showBar !== false ? "âœ…" : "â¬›"} å·¥é …é¡¯ç¤ºï¼šé–‹/é—œ`;
        }
    }

    function doAction(act) {
        if (!mTarget) return;
        const { type, pIdx, iIdx } = mTarget;
        if (act === 'addItem') { const n = prompt("å·¥é …åç¨±:", "æ–°å·¥é …"); if(n) data[pIdx].items.push({ name: n, contract: "30", start: 0, duration: 30, ms: false, showBar: true }); }
        else if (act === 'delete') { if(confirm("ç¢ºå®šåˆªé™¤?")) (type==='phase') ? data.splice(pIdx, 1) : data[pIdx].items.splice(iIdx, 1); }
        else if (act === 'editName') { const old = (type==='phase') ? data[pIdx].name : data[pIdx].items[iIdx].name; const n = prompt("ä¿®æ”¹åç¨±:", old); if(n) (type==='phase') ? data[pIdx].name = n : data[pIdx].items[iIdx].name = n; }
        else if (act === 'addPhase') { const n = prompt("éšæ®µåç¨±:", "æ–°éšæ®µ"); if(n) data.splice(pIdx + 1, 0, { name: n, color: '#7d9e6d', items: [] }); }
        else if (act === 'toggleMilestone') { data[pIdx].items[iIdx].ms = !data[pIdx].items[iIdx].ms; }
        else if (act === 'toggleBar') { data[pIdx].items[iIdx].showBar = (data[pIdx].items[iIdx].showBar === false) ? true : false; }
        document.getElementById('menu').style.display = 'none'; render();
    }

    function applyColor(e) {
        if (mTarget && mTarget.type === 'phase') { data[mTarget.pIdx].color = e.target.value; render(); }
        document.getElementById('menu').style.display = 'none';
    }

    // --- æ‹–ç§»èˆ‡æ¨™å°ºé‚è¼¯ç¶­æŒä¸è®Š ---
    function handleDrop(e, targetType, targetPIdx, targetIIdx = null) {
        e.preventDefault(); if (!dragSource) return;
        if (dragSource.type === 'phase' && targetType === 'phase') {
            const moved = data.splice(dragSource.pIdx, 1)[0]; data.splice(targetPIdx, 0, moved);
        } else if (dragSource.type === 'item') {
            const movedItem = data[dragSource.pIdx].items.splice(dragSource.iIdx, 1)[0];
            const insIdx = (targetIIdx === null) ? 0 : targetIIdx;
            data[targetPIdx].items.splice(insIdx, 0, movedItem);
        }
        dragSource = null; render();
    }

    function startBarAction(e, pIdx, iIdx, resize=false) {
        e.stopPropagation(); const item = data[pIdx].items[iIdx], sX = e.clientX, iS = item.start, iD = item.duration;
        document.onmousemove = (ev) => {
            const delta = (ev.clientX - sX) / (37.8 / 30);
            if (resize) item.duration = Math.max(0, Math.round(iD + delta));
            else item.start = Math.max(0, Math.round((iS + delta) / 5) * 5);
            render();
        };
        document.onmouseup = () => document.onmousemove = null;
    }

    function startColResize(e, id) {
        e.stopPropagation(); let obj = document.getElementById(id), sX = e.clientX, sW = obj.offsetWidth;
        document.onmousemove = (ev) => { obj.style.width = Math.max(60, sW + (ev.clientX - sX)) + 'px'; render(); };
        document.onmouseup = () => document.onmousemove = null;
    }

    function editContract(pIdx, iIdx) {
        const res = prompt("ç·¨è¼¯æ—¥æ›†å¤©æ–‡å­—:", data[pIdx].items[iIdx].contract);
        if (res !== null) { data[pIdx].items[iIdx].contract = res; render(); }
    }

    function updateRulers(count) {
        const headerW = document.getElementById('col-name').offsetWidth + document.getElementById('col-contract').offsetWidth;
        const timelineW = count * 37.8;
        let t = '', b = '';
        for (let i = 0; i <= count; i++) {
            t += `<div class="ruler-tick">${i * 30}</div>`;
            if (i < count) b += `<div class="ruler-tick" style="background:#eee">${i+1}æœˆ</div>`;
        }
        document.getElementById('topRuler').style.width = (headerW + timelineW) + 'px';
        document.getElementById('topRuler').innerHTML = `<div style="width:${headerW}px; border-right:1px solid #ccc; flex-shrink:0;"></div><div style="display:flex; width:${timelineW}px;">${t}</div>`;
        document.getElementById('bottomRuler').style.width = (headerW + timelineW) + 'px';
        document.getElementById('bottomRuler').innerHTML = `<div style="width:${headerW}px; border-right:1px solid #ccc; flex-shrink:0; text-align:center; line-height:35px; font-weight:bold;">æœˆä»½ç´¯è¨ˆ</div><div style="display:flex; width:${timelineW}px;">${b}</div>`;
    }

    function saveData() {
        const config = { nameW: document.getElementById('col-name').style.width, contractW: document.getElementById('col-contract').style.width };
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify({data, config})], {type:"application/json"})); a.download = `æ¨™æ¡ˆå­˜æª”.json`; a.click();
    }

    function loadData(e) {
        const reader = new FileReader();
        reader.onload = (ev) => { const d = JSON.parse(ev.target.result); data = d.data; if(d.config){document.getElementById('col-name').style.width=d.config.nameW; document.getElementById('col-contract').style.width=d.config.contractW;} render(); };
        reader.readAsText(e.target.files[0]);
    }

    function exportImage() {
        const area = document.getElementById('captureArea');
        html2canvas(area, { scale: 2, backgroundColor: "#ffffff", width: area.offsetWidth, height: area.offsetHeight }).then(canvas => {
            const link = document.createElement('a'); link.download = `æ¨™æ¡ˆç”˜ç‰¹åœ–.png`; link.href = canvas.toDataURL(); link.click();
        });
    }

    window.onclick = () => document.getElementById('menu').style.display = 'none';
    window.onload = render;
</script>
</body>
</html>
